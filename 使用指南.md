# QGpT ä½¿ç”¨æŒ‡å—

## ğŸ¯ æ¦‚è¿°

QGpT (Question Generation from Partial Tables) æ˜¯ä¸€å€‹æ”¹å–„è¡¨æ ¼æª¢ç´¢çš„æ¡†æ¶ï¼Œé€šéå¾éƒ¨åˆ†è¡¨æ ¼ç”Ÿæˆåˆæˆå•é¡Œä¾†æå‡é–‹æ”¾åŸŸè¡¨æ ¼æª¢ç´¢çš„æ•ˆæœã€‚æœ¬é …ç›®æä¾›å®Œæ•´çš„è¡¨æ ¼åµŒå…¥å‘é‡ç”Ÿæˆã€æœç´¢æŸ¥è©¢å’Œè©•ä¼°åŠŸèƒ½ã€‚

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

æœ¬ç³»çµ±æ¡ç”¨æ¨¡çµ„åŒ–è¨­è¨ˆï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒçµ„ä»¶ï¼š

1. **èªæ–™åº«åµŒå…¥å‘é‡å»ºç«‹å™¨** (`corpus_embedding_builder.py`)
2. **æœç´¢æŸ¥è©¢ä»‹é¢** (`qgpt_search.py`) 
3. **æŸ¥è©¢è©•ä¼°å™¨** (`query_evaluator.py`)

## ğŸ“ æª”æ¡ˆçµæ§‹

```
/Users/yaochungfan/QGpT/
â”œâ”€â”€ corpus_embedding_builder.py # èªæ–™åº«åµŒå…¥å‘é‡å»ºç«‹å™¨
â”œâ”€â”€ qgpt_search.py            # å‘½ä»¤è¡Œæœç´¢ä»‹é¢
â”œâ”€â”€ query_evaluator.py        # æŸ¥è©¢è©•ä¼°å™¨
â”œâ”€â”€ utils.py                  # å…¬ç”¨å·¥å…·å‡½æ•¸
â”œâ”€â”€ qgpt_*.db                # QGpT å‘é‡è³‡æ–™åº«æª”æ¡ˆ
â”œâ”€â”€ requirements.txt         # ä¾è³´å¥—ä»¶æ¸…å–®
â”œâ”€â”€ test_dataset/            # æ¸¬è©¦è³‡æ–™é›†ï¼ˆä¸­è‹±æ–‡å•ç­”å°ï¼‰
â”‚   â”œâ”€â”€ E2E-WTQ_test.json
â”‚   â”œâ”€â”€ FetaQA_test.json
â”‚   â”œâ”€â”€ MMQA-2tables_test.json
â”‚   â”œâ”€â”€ MMQA-3tables_test.json
â”‚   â”œâ”€â”€ MimoTable-Chinese_test.json
â”‚   â”œâ”€â”€ MimoTable-English_test.json
â”‚   â””â”€â”€ OTT-QA_test.json
â”œâ”€â”€ ä½¿ç”¨æŒ‡å—.md              # æœ¬æª”æ¡ˆï¼ˆä¸­æ–‡ä½¿ç”¨æŒ‡å—ï¼‰
â”œâ”€â”€ readme.md                # è‹±æ–‡èªªæ˜æ–‡ä»¶
â”œâ”€â”€ CODE_README.md          # ç¨‹å¼ç¢¼èªªæ˜
â””â”€â”€ UPDATED_README.md       # æ¶æ§‹æ›´æ–°èªªæ˜
```

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. ç’°å¢ƒè¨­ç½®

#### å®‰è£ä¾è³´å¥—ä»¶
```bash
pip install -r requirements.txt
```

#### ä¸»è¦ä¾è³´
- `pymilvus[model]>=2.3.0` - Milvus å‘é‡è³‡æ–™åº«å®¢æˆ¶ç«¯
- `FlagEmbedding` - BGE-M3 åµŒå…¥æ¨¡å‹
- `numpy>=1.21.0` - æ•¸å€¼é‹ç®—æ”¯æ´

### 2. å»ºç«‹èªæ–™åº«åµŒå…¥å‘é‡

#### åˆ—å‡ºæ‰€æœ‰å¯ç”¨èªæ–™åº«
```bash
python corpus_embedding_builder.py --list
```

#### ç‚ºå–®ä¸€èªæ–™åº«å»ºç«‹åµŒå…¥å‘é‡
```bash
python corpus_embedding_builder.py Corpora/Table1_mimo_table_length_variation/mimo_ch/1k_token.json
```

#### ç‚ºæ‰€æœ‰èªæ–™åº«å»ºç«‹åµŒå…¥å‘é‡
```bash
python corpus_embedding_builder.py --all
```

#### å¼·åˆ¶é‡å»ºå·²å­˜åœ¨çš„è³‡æ–™åº«
```bash
python corpus_embedding_builder.py --all --force
```

### 3. æŸ¥è©¢è©•ä¼°

#### å–®ä¸€æŸ¥è©¢è©•ä¼°
```bash
python query_evaluator.py "ä½ çš„æŸ¥è©¢..." --db qgpt_Table1_mimo_ch.db
```

#### ä½¿ç”¨æ¸¬è©¦æª”æ¡ˆè©•ä¼°
```bash
python query_evaluator.py --test-file test_dataset/MimoTable-English_test.json --db qgpt_Table1_mimo_en.db
```

#### æ‰¹æ¬¡è©•ä¼°æ‰€æœ‰æ¸¬è©¦é›†
```bash
python query_evaluator.py --batch-eval
```

## ğŸ”§ ç³»çµ±æ¶æ§‹èˆ‡å·¥ä½œæµç¨‹

### è³‡æ–™åº«å‘½åè¦å‰‡

ç³»çµ±æœƒæ ¹æ“šèªæ–™åº«è·¯å¾‘è‡ªå‹•ç”Ÿæˆè³‡æ–™åº«å’Œé›†åˆåç¨±ï¼Œ**æ¯å€‹ JSON æª”æ¡ˆå°æ‡‰ä¸€å€‹ç¨ç«‹çš„è³‡æ–™åº«**ï¼š

```
èªæ–™åº«è·¯å¾‘ â†’ è³‡æ–™åº«åç¨±ï¼ˆåŒ…å«å®Œæ•´æª”æ¡ˆè·¯å¾‘ï¼‰
Corpora/Table1_mimo_table_length_variation/mimo_ch/1k_token.json 
â†’ qgpt_T1_MTLV_mimo_ch_1k_token.db

å‘é‡é›†åˆåç¨±
Table1_mimo_table_length_variation_mimo_ch_1k_token 
â†’ emb_T1_MTLV_mimo_ch_1k_token
```

#### å‘½åç°¡åŒ–è¦å‰‡ï¼š
- `Table` â†’ `T`ï¼ˆç°¡åŒ–è¡¨æ ¼ç·¨è™Ÿï¼‰
- `mimo_table_length_variation` â†’ `MTLV`
- `Single_Table_Retrieval` â†’ `STR`
- `Multi_Table_Retrieval` â†’ `MTR`
- `table_representation` â†’ `TR`

#### ç¯„ä¾‹å°ç…§ï¼š
```
æª”æ¡ˆåç¨±                                          è³‡æ–™åº«åç¨±
1k_token.json                            â†’ qgpt_T1_MTLV_mimo_ch_1k_token.db
2k_token.json                            â†’ qgpt_T1_MTLV_mimo_ch_2k_token.db
5k_token.json                            â†’ qgpt_T1_MTLV_mimo_ch_5k_token.db
Full-Table(8k).json                      â†’ qgpt_T1_MTLV_mimo_ch_Full-T(8k).db
E2EWTQ_QGpT.json                         â†’ qgpt_T5SingleTRetrievalQGpTE2E.db
pT.json                                  â†’ qgpt_T3_mimo_en_TR_pT.db
```

### è™•ç†æµç¨‹

1. **è³‡æ–™è¼‰å…¥**: å¾ Corpora ç›®éŒ„è¼‰å…¥è¡¨æ ¼ JSON è³‡æ–™
2. **çµæ§‹é©—è­‰**: é©—è­‰èªæ–™åº«è³‡æ–™æ ¼å¼å’Œå®Œæ•´æ€§
3. **è³‡æ–™åº«å‘½å**: æ ¹æ“šå®Œæ•´æª”æ¡ˆè·¯å¾‘è‡ªå‹•ç”Ÿæˆå”¯ä¸€çš„è³‡æ–™åº«åç¨±
4. **æ–‡å­—é è™•ç†**: æ¸…ç†å’Œæ ¼å¼åŒ–è¡¨æ ¼æ–‡å­—
5. **åµŒå…¥ç”Ÿæˆ**: ä½¿ç”¨ BGE-M3 æ¨¡å‹ç”Ÿæˆ 1024 ç¶­å‘é‡
6. **å‘é‡å„²å­˜**: ä½¿ç”¨ Milvus ç‚ºæ¯å€‹ JSON æª”æ¡ˆå»ºç«‹ç¨ç«‹çš„å‘é‡è³‡æ–™åº«
7. **èªç¾©æœç´¢**: åŸºæ–¼å‘é‡ç›¸ä¼¼åº¦é€²è¡Œæª¢ç´¢
8. **çµæœè©•ä¼°**: æ”¯æ´èˆ‡ ground truth æ¯”è¼ƒè©•ä¼°

#### è³‡æ–™åº«éš”é›¢å„ªå‹¢ï¼š
- **ç²¾ç¢ºæ§åˆ¶**: æ¯å€‹èªæ–™åº«æª”æ¡ˆç¨ç«‹ç®¡ç†å’ŒæŸ¥è©¢
- **é¿å…æ··æ·†**: ä¸åŒå¯¦é©—æ¢ä»¶çš„è³‡æ–™å®Œå…¨éš”é›¢
- **éˆæ´»æ“ä½œ**: å¯ä»¥å–®ç¨é‡å»ºã€æŸ¥è©¢æˆ–åˆªé™¤ç‰¹å®šè³‡æ–™é›†
- **ç‰ˆæœ¬ç®¡ç†**: åŒä¸€æ¦‚å¿µä¸‹çš„ä¸åŒç‰ˆæœ¬ï¼ˆå¦‚ä¸åŒ token é•·åº¦ï¼‰å„è‡ªç¨ç«‹

### æ”¯æ´çš„èªæ–™åº«

ç³»çµ±æ”¯æ´ä»¥ä¸‹å¯¦é©—èªæ–™åº«ï¼š
- `Table1_mimo_table_length_variation/` - è¡¨æ ¼é•·åº¦è®ŠåŒ–å¯¦é©—
- `Table3_mimo_en_table_representation/` - è¡¨æ ¼è¡¨ç¤ºæ–¹æ³•å¯¦é©—  
- `Table5_Single_Table_Retrieval/` - å–®è¡¨æª¢ç´¢å¯¦é©—
- `Table6_Multi_Table_Retrieval/` - å¤šè¡¨æª¢ç´¢å¯¦é©—
- `Table7_OTTQA/` - OTTQA è³‡æ–™é›†å¯¦é©—

### æ¸¬è©¦è³‡æ–™é›†

`test_dataset/` è³‡æ–™å¤¾åŒ…å«ç”¨æ–¼ recall@k è©•ä¼°çš„å•ç­”å°è³‡æ–™ï¼š
- **E2E-WTQ**: `E2E-WTQ_test.json` - ç«¯åˆ°ç«¯ç¶­åŸºè¡¨æ ¼å•ç­”
- **FeTAQA**: `FetaQA_test.json` - çµæ§‹åŒ–è¡¨æ ¼å•ç­”
- **MMQA 2tables**: `MMQA-2tables_test.json` - å¤šæ¨¡æ…‹å•ç­”ï¼ˆ2è¡¨ï¼‰
- **MMQA 3tables**: `MMQA-3tables_test.json` - å¤šæ¨¡æ…‹å•ç­”ï¼ˆ3è¡¨ï¼‰
- **MimoTable ä¸­æ–‡**: `MimoTable-Chinese_test.json` - ä¸­æ–‡è¡¨æ ¼å•ç­”
- **MimoTable è‹±æ–‡**: `MimoTable-English_test.json` - è‹±æ–‡è¡¨æ ¼å•ç­”
- **OTTQA**: `OTT-QA_test.json` - é–‹æ”¾è¡¨æ ¼å•ç­”

## ğŸ“ˆ æ•ˆèƒ½æŒ‡æ¨™

- **åµŒå…¥æ¨¡å‹**: BGE-M3 (BAAI/bge-m3) ä½¿ç”¨ FP16 ç²¾åº¦
- **å‘é‡ç¶­åº¦**: 1024 ç¶­ 
- **æœç´¢é€Ÿåº¦**: æ¯«ç§’ç´šéŸ¿æ‡‰
- **ç›¸ä¼¼åº¦ç¯„åœ**: 0.0 - 1.0 (è¶Šé«˜è¶Šç›¸ä¼¼)
- **æ”¯æ´èªè¨€**: å¢å¼·çš„ä¸­æ–‡ã€è‹±æ–‡åŠæ··åˆæŸ¥è©¢èƒ½åŠ›
- **å¯¦æ¸¬æ€§èƒ½**: MimoTable-English æ¸¬è©¦é›†é”åˆ° 77.22% å‘½ä¸­ç‡@10
- **è³‡æ–™åº«æ ¼å¼**: Milvus å‘é‡è³‡æ–™åº« (.db æª”æ¡ˆ)

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

1. **æ‰¾ä¸åˆ°é›†åˆéŒ¯èª¤**
   ```
   éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°é›†åˆ 'qgpt_table_embeddings'
   ```
   è§£æ±ºæ–¹æ¡ˆ: å…ˆåŸ·è¡Œ `python corpus_embedding_builder.py` å»ºç«‹è³‡æ–™åº«

2. **ç·¨ç¢¼éŒ¯èª¤**
   ç¢ºä¿çµ‚ç«¯æ”¯æ´ UTF-8 ç·¨ç¢¼ï¼Œç‰¹åˆ¥æ˜¯åœ¨ Windows ç³»çµ±ä¸Š

3. **è¨˜æ†¶é«”ä¸è¶³**
   è™•ç†å¤§é‡è³‡æ–™æ™‚å¯èƒ½éœ€è¦æ›´å¤šè¨˜æ†¶é«”ï¼Œè€ƒæ…®åˆ†æ‰¹è™•ç†

### ä¾è³´å•é¡Œ

å¦‚æœé‡åˆ°å¥—ä»¶ç›¸é—œå•é¡Œï¼Œè«‹ç¢ºä¿ï¼š
- Python ç‰ˆæœ¬ >= 3.8
- å·²å®‰è£æ‰€æœ‰å¿…è¦ä¾è³´ï¼š`pip install -r requirements.txt`

## ğŸ“ ç›¸é—œè«–æ–‡

å¦‚æœæ‚¨ä½¿ç”¨äº†é€™å€‹ç³»çµ±ï¼Œè«‹å¼•ç”¨æˆ‘å€‘çš„è«–æ–‡ï¼š

```bibtex
@inproceedings{
liang2025improving,
title={Improving Table Retrieval with Question Generation from Partial Tables},
author={Hsing-Ping Liang and Che-Wei Chang and Yao-Chung Fan},
booktitle={The 4th Table Representation Learning Workshop at ACL 2025},
year={2025},
url={https://openreview.net/forum?id=Q8HOV0UMwA}
}
```

## ğŸ“§ è¯çµ¡æ–¹å¼

å¦‚æœ‰å•é¡Œæˆ–å»ºè­°ï¼Œè«‹è¯çµ¡ï¼šcc3374twa@gmail.com

## ï¿½ é€²éšåŠŸèƒ½

### æ‰¹æ¬¡è™•ç†

ç³»çµ±æ”¯æ´æ‰¹æ¬¡å»ºç«‹æ‰€æœ‰èªæ–™åº«çš„åµŒå…¥å‘é‡ï¼š
```bash
# å»ºç«‹æ‰€æœ‰èªæ–™åº«ï¼ˆè·³éå·²å­˜åœ¨çš„ï¼‰
python corpus_embedding_builder.py --all

# å¼·åˆ¶é‡å»ºæ‰€æœ‰èªæ–™åº«
python corpus_embedding_builder.py --all --force
```

### è©•ä¼°åŠŸèƒ½

#### å–®ä¸€æŸ¥è©¢æ¸¬è©¦
```bash
python query_evaluator.py "financial data" --db qgpt_Table5_Single_Table_Retrieval_QGpT.db --limit 5
```

#### æ‰¹æ¬¡è©•ä¼°èˆ‡çµæœå„²å­˜
```bash
# æ‰¹æ¬¡è©•ä¼°ä¸¦å„²å­˜çµæœ
python query_evaluator.py --batch-eval --save

# æŒ‡å®šè©•ä¼°é™åˆ¶æ•¸é‡
python query_evaluator.py --batch-eval --limit 10
```

### æ™ºæ…§è³‡æ–™åº«é¸æ“‡

æœç´¢æ™‚ç³»çµ±æœƒè‡ªå‹•ï¼š
1. åµæ¸¬ç•¶å‰ç›®éŒ„ä¸‹çš„æ‰€æœ‰ .db æª”æ¡ˆ
2. å¦‚æœåªæœ‰ä¸€å€‹è³‡æ–™åº«ï¼Œè‡ªå‹•é¸æ“‡
3. å¦‚æœæœ‰å¤šå€‹è³‡æ–™åº«ï¼Œæä¾›é¸æ“‡æ¸…å–®
4. æ”¯æ´ `--list-dbs` æŸ¥çœ‹æ‰€æœ‰å¯ç”¨è³‡æ–™åº«

