# QGpT 使用指南

## 🎯 概述

QGpT (Question Generation from Partial Tables) 是一個改善表格檢索的框架，通過從部分表格生成合成問題來提升開放域表格檢索的效果。本項目提供完整的表格嵌入向量生成、搜索查詢和評估功能。

## 🏗️ 系統架構

本系統採用模組化設計，包含以下核心組件：

1. **語料庫嵌入向量建立器** (`corpus_embedding_builder.py`)
2. **搜索查詢介面** (`qgpt_search.py`) 
3. **查詢評估器** (`query_evaluator.py`)

## 📁 檔案結構

```
/Users/yaochungfan/QGpT/
├── corpus_embedding_builder.py # 語料庫嵌入向量建立器
├── qgpt_search.py            # 命令行搜索介面
├── query_evaluator.py        # 查詢評估器
├── utils.py                  # 公用工具函數
├── qgpt_*.db                # QGpT 向量資料庫檔案
├── requirements.txt         # 依賴套件清單
├── test_dataset/            # 測試資料集（中英文問答對）
│   ├── E2E-WTQ_test.json
│   ├── FetaQA_test.json
│   ├── MMQA-2tables_test.json
│   ├── MMQA-3tables_test.json
│   ├── MimoTable-Chinese_test.json
│   ├── MimoTable-English_test.json
│   └── OTT-QA_test.json
├── 使用指南.md              # 本檔案（中文使用指南）
├── readme.md                # 英文說明文件
├── CODE_README.md          # 程式碼說明
└── UPDATED_README.md       # 架構更新說明
```

## 🚀 快速開始

### 1. 環境設置

#### 安裝依賴套件
```bash
pip install -r requirements.txt
```

#### 主要依賴
- `pymilvus[model]>=2.3.0` - Milvus 向量資料庫客戶端
- `FlagEmbedding` - BGE-M3 嵌入模型
- `numpy>=1.21.0` - 數值運算支援

### 2. 建立語料庫嵌入向量

#### 列出所有可用語料庫
```bash
python corpus_embedding_builder.py --list
```

#### 為單一語料庫建立嵌入向量
```bash
python corpus_embedding_builder.py Corpora/Table1_mimo_table_length_variation/mimo_ch/1k_token.json
```

#### 為所有語料庫建立嵌入向量
```bash
python corpus_embedding_builder.py --all
```

#### 強制重建已存在的資料庫
```bash
python corpus_embedding_builder.py --all --force
```

### 3. 查詢評估

#### 單一查詢評估
```bash
python query_evaluator.py "你的查詢..." --db qgpt_Table1_mimo_ch.db
```

#### 使用測試檔案評估
```bash
python query_evaluator.py --test-file test_dataset/MimoTable-English_test.json --db qgpt_Table1_mimo_en.db
```

#### 批次評估所有測試集
```bash
python query_evaluator.py --batch-eval
```

## 🔧 系統架構與工作流程

### 資料庫命名規則

系統會根據語料庫路徑自動生成資料庫和集合名稱，**每個 JSON 檔案對應一個獨立的資料庫**：

```
語料庫路徑 → 資料庫名稱（包含完整檔案路徑）
Corpora/Table1_mimo_table_length_variation/mimo_ch/1k_token.json 
→ qgpt_T1_MTLV_mimo_ch_1k_token.db

向量集合名稱
Table1_mimo_table_length_variation_mimo_ch_1k_token 
→ emb_T1_MTLV_mimo_ch_1k_token
```

#### 命名簡化規則：
- `Table` → `T`（簡化表格編號）
- `mimo_table_length_variation` → `MTLV`
- `Single_Table_Retrieval` → `STR`
- `Multi_Table_Retrieval` → `MTR`
- `table_representation` → `TR`

#### 範例對照：
```
檔案名稱                                          資料庫名稱
1k_token.json                            → qgpt_T1_MTLV_mimo_ch_1k_token.db
2k_token.json                            → qgpt_T1_MTLV_mimo_ch_2k_token.db
5k_token.json                            → qgpt_T1_MTLV_mimo_ch_5k_token.db
Full-Table(8k).json                      → qgpt_T1_MTLV_mimo_ch_Full-T(8k).db
E2EWTQ_QGpT.json                         → qgpt_T5SingleTRetrievalQGpTE2E.db
pT.json                                  → qgpt_T3_mimo_en_TR_pT.db
```

### 處理流程

1. **資料載入**: 從 Corpora 目錄載入表格 JSON 資料
2. **結構驗證**: 驗證語料庫資料格式和完整性
3. **資料庫命名**: 根據完整檔案路徑自動生成唯一的資料庫名稱
4. **文字預處理**: 清理和格式化表格文字
5. **嵌入生成**: 使用 BGE-M3 模型生成 1024 維向量
6. **向量儲存**: 使用 Milvus 為每個 JSON 檔案建立獨立的向量資料庫
7. **語義搜索**: 基於向量相似度進行檢索
8. **結果評估**: 支援與 ground truth 比較評估

#### 資料庫隔離優勢：
- **精確控制**: 每個語料庫檔案獨立管理和查詢
- **避免混淆**: 不同實驗條件的資料完全隔離
- **靈活操作**: 可以單獨重建、查詢或刪除特定資料集
- **版本管理**: 同一概念下的不同版本（如不同 token 長度）各自獨立

### 支援的語料庫

系統支援以下實驗語料庫：
- `Table1_mimo_table_length_variation/` - 表格長度變化實驗
- `Table3_mimo_en_table_representation/` - 表格表示方法實驗  
- `Table5_Single_Table_Retrieval/` - 單表檢索實驗
- `Table6_Multi_Table_Retrieval/` - 多表檢索實驗
- `Table7_OTTQA/` - OTTQA 資料集實驗

### 測試資料集

`test_dataset/` 資料夾包含用於 recall@k 評估的問答對資料：
- **E2E-WTQ**: `E2E-WTQ_test.json` - 端到端維基表格問答
- **FeTAQA**: `FetaQA_test.json` - 結構化表格問答
- **MMQA 2tables**: `MMQA-2tables_test.json` - 多模態問答（2表）
- **MMQA 3tables**: `MMQA-3tables_test.json` - 多模態問答（3表）
- **MimoTable 中文**: `MimoTable-Chinese_test.json` - 中文表格問答
- **MimoTable 英文**: `MimoTable-English_test.json` - 英文表格問答
- **OTTQA**: `OTT-QA_test.json` - 開放表格問答

## 📈 效能指標

- **嵌入模型**: BGE-M3 (BAAI/bge-m3) 使用 FP16 精度
- **向量維度**: 1024 維 
- **搜索速度**: 毫秒級響應
- **相似度範圍**: 0.0 - 1.0 (越高越相似)
- **支援語言**: 增強的中文、英文及混合查詢能力
- **實測性能**: MimoTable-English 測試集達到 77.22% 命中率@10
- **資料庫格式**: Milvus 向量資料庫 (.db 檔案)

## 🛠️ 故障排除

### 常見問題

1. **找不到集合錯誤**
   ```
   錯誤：找不到集合 'qgpt_table_embeddings'
   ```
   解決方案: 先執行 `python corpus_embedding_builder.py` 建立資料庫

2. **編碼錯誤**
   確保終端支援 UTF-8 編碼，特別是在 Windows 系統上

3. **記憶體不足**
   處理大量資料時可能需要更多記憶體，考慮分批處理

### 依賴問題

如果遇到套件相關問題，請確保：
- Python 版本 >= 3.8
- 已安裝所有必要依賴：`pip install -r requirements.txt`

## 📝 相關論文

如果您使用了這個系統，請引用我們的論文：

```bibtex
@inproceedings{
liang2025improving,
title={Improving Table Retrieval with Question Generation from Partial Tables},
author={Hsing-Ping Liang and Che-Wei Chang and Yao-Chung Fan},
booktitle={The 4th Table Representation Learning Workshop at ACL 2025},
year={2025},
url={https://openreview.net/forum?id=Q8HOV0UMwA}
}
```

## 📧 聯絡方式

如有問題或建議，請聯絡：cc3374twa@gmail.com

## � 進階功能

### 批次處理

系統支援批次建立所有語料庫的嵌入向量：
```bash
# 建立所有語料庫（跳過已存在的）
python corpus_embedding_builder.py --all

# 強制重建所有語料庫
python corpus_embedding_builder.py --all --force
```

### 評估功能

#### 單一查詢測試
```bash
python query_evaluator.py "financial data" --db qgpt_Table5_Single_Table_Retrieval_QGpT.db --limit 5
```

#### 批次評估與結果儲存
```bash
# 批次評估並儲存結果
python query_evaluator.py --batch-eval --save

# 指定評估限制數量
python query_evaluator.py --batch-eval --limit 10
```

### 智慧資料庫選擇

搜索時系統會自動：
1. 偵測當前目錄下的所有 .db 檔案
2. 如果只有一個資料庫，自動選擇
3. 如果有多個資料庫，提供選擇清單
4. 支援 `--list-dbs` 查看所有可用資料庫

